#!/bin/sh
#
# Aldoratech A19M default parameters.
#
# NOTE: Script variables are declared/initialized/unset in the rcS script.
#
# Some parameters are defined with it's already default value but are
# write here due to its relevance and for possible future modifications.

set VEHICLE_TYPE vtol

###############################
####### Airspeed params #######
###############################

# Enable checks on airspeed sensors.
param set-default ASPD_DO_CHECKS 1

# Enable fallback to sensor-less airspeed estimation. We only want airspeed data so it's disabled.
param set-default ASPD_FALLBACK_GW 0

# Airspeed failsafe start delay. If airspeed lost and recovered, wait 1s having good data to start using it again.
param set-default ASPD_FS_T_START 1

# Airspeed failsafe stop delay. If airspeed has bad data wait 2 seconds before stop using it.
param set-default ASPD_FS_T_STOP 2

# Index or primary airspeed measurement source.
# Values:
#     -1: Disabled
#     0: Groundspeed minus windspeed
#     1: First airspeed sensor
#     2: Second airspeed sensor
#     3: Third airspeed sensor
param set-default ASPD_PRIMARY 1


# Airspeed scale (scale from IAS to CAS). Set to 1.15 for empiric data but need to be calibrated
param set-default ASPD_SCALE 1

# Airspeed mode: tube pressure drop
param set-default CAL_AIR_CMODEL 1

# Lenght of tubes of the pitot
param set-default CAL_AIR_TUBELEN  0.16




##############################
####### Battery params #######
##############################

# Battery 1 current per volt (A/V). Need to be calibrated to adjust
param set-default BAT1_A_PER_V 65.2252426147461

# Battery 1 voltage divider (V divider). Need to be calibrated to adjust
param set-default BAT1_V_DIV 19.229450225830078

# Capacity in mAh
param set-default BAT1_CAPACITY 16000

param set-default BAT1_N_CELLS 6

# For now set deactivated. Need to test if it's better than BAT1_V_LOAD_DROP
param set-default BAT1_R_INTERNAL -1.0

# Battery 1 monitoring source
# Comment: This parameter controls the source of battery data. The value 'Power Module' means that measurements are expected to come from a power module. If the value is set to 'External' then the system expects to receive mavlink battery status messages. If the value is set to 'ESCs', the battery information are taken from the esc_status message. This requires the ESC to provide both voltage as well as current.
# Values:
#     -1: Disabled
#     0: Power Module
#     1: External
#     2: ESCs
# For now is set to Power module. Maybe in the future we'll implement it via mavlink (external)
param set-default BAT1_SOURCE 0

# Full cell voltage (5C load). Not tested, is the default value, it'll need to be tested in the future.
param set-default BAT1_V_CHARGED 4.05

# Empty cell voltage (5C load). Not tested, is the default value, it'll need to be tested in the future.
param set-default BAT1_V_EMPTY 3.2

# Voltage drop per cell on full throttle. Set to it's maximum value but not tested.
param set-default BAT1_V_LOAD_DROP 0.5

# Thresholds for emergency, critical and low battery levels
param set-default BAT_EMERGEN_THR 0.08
param set-default BAT_CRIT_THR 0.1
param set-default BAT_LOW_THR 0.2

# Required number of redundant power modules.
param set-default COM_POWER_COUNT 1

################################
####### Commander params #######
################################

# Enable preflight check for maximal allowed airspeed when arming.
# Comment: Deny arming if the current airspeed measurement is greater than half the cruise airspeed (FW_AIRSPD_TRIM).
# Set to enabled to avoid arming with bad airspeed data.
param set-default COM_ARM_ARSP_EN 1

# Require valid mission to arm.
# Disabled for now but may be enabled in the future.
param set-default COM_ARM_MIS_REQ 0

# Enable FMU SD card detection check
# Values:
#     0: Disabled
#     1: Warning only
#     2: Enforce SD card presence
# Enforce SD card. It can be changed if necessary on testing
param set-default COM_ARM_SDCARD 2

# Arm switch is a momentary button
# Comment: 0: Arming/disarming triggers on switch transition. 1: Arming/disarming triggers when holding the momentary button down for COM_RC_ARM_HYST like the stick gesture.
# Default for now. May be changed in the future.
param set-default COM_ARM_SWISBTN 0

# Related to above. Value in ms.
param set-default COM_RC_ARM_HYST 1000

# Allow arming without GPS
# Values:
#     0: Require GPS lock to arm
#     1: Allow arming without GPS
# Enforce GPS lock for arming. Deactivate for testing
param set-default COM_ARM_WO_GPS 0

# Time-out for auto disarm after landing.
# Set to default 2s
param set-default COM_DISARM_LAND 2.0

# Time-out for auto disarm if not taking off.
# Set to default 10s
param set-default COM_DISARM_PRFLT 10.0

#########################
####### Failsaves #######
#########################

# Datalink loss time threshold in seconds.
# Set to 5s as th 10s default seems very large
param set-default COM_DL_LOSS_T 5.0

# Set data link loss failsafe mode
# Values:
#     0: Disabled
#     1: Hold mode
#     2: Return mode
#     3: Land mode
#     5: Terminate
#     6: Lockdown
# This failsafe is only triggered in mission mode so it's safe to assume that Return mode will work correctly.
param set-default NAV_DLL_ACT 2

# Battery failsafe mode
# Values:
#     0: Warning
#     2: Land mode
#     3: Return at critical level, land at emergency level
# Set to only warning since the battery monitoring still needs to be tested
param set-default COM_LOW_BAT_ACT 0

# RC loss time threshold.
# Set to default 0.5s
param set-default COM_RC_LOSS_T 0.5

# Delay between RC loss and configured reaction
# During this time the vehicle will stay in HOLD mode waiting for regaining signal.
param set-default COM_RCL_ACT_T 10.0

# Set RC loss failsafe mode
# Values:
#     1: Hold mode
#     2: Return mode
#     3: Land mode
#     5: Terminate
#     6: Lockdown
# If it can't be in Return for other reasons, it will automatically switch to Land or Terminate
param set-default NAV_RCL_ACT 2

# RC loss exceptions
# Comment: Specify modes in which RC loss is ignored and the failsafe action not triggered.
# Bitmask:
#     1: Mission
#     2: Hold
#     4: Offboard
# No exceptions for now
param set-default COM_RCL_EXCEPT 0

# Position control navigation loss response (GPS)
# Values:
#     0: Altitude/Manual. Assume use of remote control after fallback. Switch to Altitude mode if a height estimate is available, else switch to MANUAL.
#     1: Land/Terminate. Assume no use of remote control after fallback. Switch to Land mode if a height estimate is available, else switch to TERMINATION.
# For now the vehicle will always have radio link. In the future it will be set to 1.
param set-default COM_POSCTL_NAVL 0


# Enable RC stick override of auto and/or offboard modes
# Comment: When RC stick override is enabled, moving the RC sticks more than COM_RC_STICK_OV from their center position immediately gives control back to the pilot by switching to Position mode. Note: Only has an effect on multicopters, and VTOLs in multicopter mode.
# Bitmask:
#     1: Enable override during auto modes (except for in critical battery reaction)
#     2: Enable override during offboard mode
#     4: Ignore throttle stick
# Override in auto or offboard modes, don't ignore the throttle stick.
param set-default COM_RC_OVERRIDE 3


##########################
####### EKF params #######
##########################

# Airspeed fusion threshold. Set to about 90% of the vehicles stall speed.
# Needs to be calibrated when tests are made
param set-default EKF2_ARSP_THR 16

# Upper limit on airspeed along individual axes used to correct baro for position error effects
# Default is 20, as we fly over that, we set 30
param set-default EKF2_ASPD_MAX 30

# Boolean determining if synthetic sideslip measurements should fused.
# Used to fly if GPS is lost.
# Needs to be tested but enabled.
param set-default EKF2_FUSE_BETA 1


#################################
####### Fixed Wing params #######
#################################

# Values:
#     0: Normal (use airspeed if available)
#     1: Airspeed disabled
param set-default FW_ARSP_MODE 0

# Pitch setpoint offset (pitch at level flight)
# Set to 0 until calibrated
param set-default FW_PSP_OFF 0

# Direct feed forward from pitch, roll and yaw rate setpoint to control surface output
# Set to default values for now
param set-default FW_PR_FF 0.7
param set-default FW_RR_FF 0.6
param set-default FW_YR_FF 0.07

# Pitch, roll and yaw rate P, I and max I
# Set to default values for now
param set-default FW_PR_P 0.08
param set-default FW_PR_I 0.1
param set-default FW_PR_IMAX 0.4

param set-default FW_RR_P 0.05
param set-default FW_RR_I 0.1
param set-default FW_RR_IMAX 0.2

param set-default FW_YR_P 0.05
param set-default FW_YR_I 0.1
param set-default FW_YR_IMAX 0.2

# Maximum negative / down and positive / up pitch rate deg/s
# Maximum roll rate and yaw rate
# Set to a lower value than default
param set-default FW_P_RMAX_NEG 30
param set-default FW_P_RMAX_POS 30
param set-default FW_R_RMAX 45
param set-default FW_Y_RMAX 20


# This is the L1 distance and defines the tracking point ahead of the aircraft its following.
# Set to a big value for very smooth control
param set-default FW_L1_PERIOD 40

# Pitch and roll angle limits
# Set lower than default. Need to be calibrated
param set-default FW_P_LIM_MAX 20
param set-default FW_P_LIM_MIN -15
param set-default FW_R_LIM 40

# Max pitch in degrees for manual control in attitude stabilized mode
# Don't set higher than FW_P_LIM_MAX/MIN
param set-default FW_MAN_P_MAX 20

# Max roll for manual control in attitude stabilized mode
# Don't set higher than FW_R_LIM
param set-default FW_MAN_R_MAX 30

# Cruise throttle.
# Set to default. Need to be calibrated
param set-default FW_THR_CRUISE 0.6

# Idle throttle. Always 0 for cruise electric motors
param set-default FW_THR_IDLE 0.0

# Max and min throttle (norm)
# Min is always 0. Max could be calibrated to lower than 1
param set-default FW_THR_MAX 1.0
param set-default FW_THR_MIN 0.0

# Max, min, stall and cruise (trim) speeds of the aircraft.
# Calibrated or hard set
param set-default FW_AIRSPD_MAX 28
param set-default FW_AIRSPD_MIN 20
param set-default FW_AIRSPD_STALL 18
param set-default FW_AIRSPD_TRIM 23

# The controller will increase the commanded airspeed to maintain this minimum groundspeed to the next waypoint.
# Setting it to default 5 m/s virtually disables the parameter
param set-default FW_GND_SPD_MIN 5

# Maximum climb rate m/s.
# Calibrated or hard set.
param set-default FW_T_CLMB_MAX 4

# Climb rate setpoint for auto or maximum for manual.
# Set to default.
param set-default FW_T_CLMB_R_SP 3

# Maximum and minimum descend rates
# Calibrated or hard set.
param set-default FW_T_SINK_MAX 5
param set-default FW_T_SINK_MIN 3

# Descend rate setpoint for auto or limit for manual
# Default
param set-default FW_T_SINK_R_SP 2

# Advanced parameters for TECS tunning available that are not listed here

###############################
####### Geofence params #######
###############################

# Geofence violation action.
# Values:
#     0: None
#     1: Warning
#     2: Hold mode
#     3: Return mode
#     4: Terminate
#     5: Land mode
# For now we'll set return mode
param set-default GF_ACTION 3


##############################
####### Mavlink params #######
##############################

# Broadcast heartbeats on local network for MAVLink instance 0
# Values:
#     0: Never broadcast
#     1: Always broadcast
#     2: Only multicast
param set-default MAV_0_BROADCAST 1

# Values:
#     0: Disabled
#     6: UART 6
#     101: TELEM 1
#     102: TELEM 2
#     103: TELEM 3
#     104: TELEM/SERIAL 4
#     201: GPS 1
#     202: GPS 2
#     203: GPS 3
#     300: Radio Controller
#     301: Wifi Port
#     1000: Ethernet
# Mavlink port that connects with the telemetry on the drone
param set-default MAV_0_CONFIG 101

# Enable MAVLink Message forwarding for instance 0
# Always formward. It allows to receive all the messages on other mavlink nodes
param set-default MAV_0_FORWARD 1

# Mavlink mode means the set of messages that are sent from the flight controller through this instance.
# Set to custom
param set-default MAV_0_MODE 1

# Mavlink type. 22 is standard VTOL
param set-default MAV_TYPE 22


##############################
####### Mission params #######
##############################

# Maximal horizontal distance from home to first waypoint  in m
param set-default MIS_DIST_1WP 1000

# Maximal horizontal distance between waypoint.
# Set to "low" value. This forces the planner to have more waypoints
param set-default MIS_DIST_WPS 1000

# Takeoff altitude in m
param set-default MIS_TAKEOFF_ALT 20

# Time in seconds we wait on reaching target heading at a waypoint if it is forced
param set-default MIS_YAW_TMT 10

# Values:
#     0: towards waypoint
#     1: towards home
#     2: away from home
#     3: along trajectory
#     4: towards waypoint (yaw first)
# This is only for MC in auto mode.
# Along trajectory is also a good option
param set-default MPC_YAW_MODE 4

# Acceptance Radius in MC. For FW L1_PERIOD is used
param set-default NAV_ACC_RAD 3

# Force VTOL mode takeoff and land.
# Enabled
param set-default NAV_FORCE_VT 1

# FW Altitude Acceptance Radius
param set-default NAV_FW_ALT_RAD 10.0

# FW loiter radius.
# Set to 500 to avoid sharp turns. It can be lowered slowly on calibration
param set-default NAV_LOITER_RAD 500

# MC Altitude Acceptance Radius
param set-default NAV_MC_ALT_RAD 1.0

# Set traffic avoidance mode
# Values:
#     0: Disabled
#     1: Warn only
#     2: Return mode
#     3: Land mode
#     4: Position Hold mode
# As this isn't likely to ever be used, we only set the warnings
param set-default NAV_TRAFF_AVOID 1


###################################
####### Multi-copter params #######
###################################

# The air-mode enables the mixer to increase the total thrust of the multirotor in order to keep attitude and rate control even at low and high throttle.
# Always disable when tunning
param set-default MC_AIRMODE 1

# Pitch, roll and yaw P gains. Desired angular speed in rad/s for error 1 rad.
# Need to be tunned. Set to A14M values.
param set-default MC_PITCH_P 5
param set-default MC_ROLL_P 4.5
param set-default MC_YAW_P 1.3

# MC PID parameters not listed as with the P values should be enough.
# If tunned, they have to be added here

# Pitch, roll and yaw maximum rates in deg/s
# Set to lower than default
param set-default MC_PITCHRATE_MAX 100
param set-default MC_ROLLRATE_MAX 100
param set-default MC_YAWRATE_MAX 60

# Maximum yaw rate in auto modes
# Set to default
param set-default MPC_YAWRAUTO_MAX 45

# Values:
#     0: Altitude following
#     1: Terrain following
# Terrain following requires a precise altitude sensor such as a lidar
param set-default MPC_ALT_MODE 0

# Maximum horizontal, up and down values
# Set to very low values for smooth control
param set-default MPC_ACC_HOR_MAX 2
param set-default MPC_ACC_DOWN_MAX 2
param set-default MPC_ACC_UP_MAX 2

# Horizontal acceleration setpoint for auto mode
param set-default MPC_ACC_HOR 2

# Jerk: Derivate of the acceleration (how fast acceleration changes over time)

# Max jerk in manual
param set-default MPC_JERK_MAX 4

# Jerk setpoint in auto
param set-default MPC_JERK_AUTO 4

# Manual-Position control sub-mode
# Values:
#     0: Simple position control (velocity based input)
#     3: Smooth position control (Jerk optimized)
#     4: Acceleration based input
param set-default MPC_POS_MODE 3

# Maximum horizontal velocity in mission m/s
param set-default MPC_XY_CRUISE 3

# Maximum horizontal error allowed by the trajectory generator
param set-default MPC_XY_ERR_MAX 5

# Maximum horizontal velocity in AUTO mode.
param set-default MPC_XY_VEL_MAX 4

# Maximum descend and ascend velocities in AUTO mode and endpoints for manual
param set-default MPC_Z_VEL_MAX_DN 1.5
param set-default MPC_Z_VEL_MAX_UP 3.0


# Landing procedure:
# When above MPC_LAND_ALT1, descend speed is MPC_Z_VEL_MAX_DN.
# Between MPC_LAND_ALT1 and MPC_LAND_ALT2, descend speed is linear between MPC_Z_VEL_MAX_DN and MPC_LAND_SPEED.
# Below MPC_LAND_ALT2, descend speed is MPC_LAND_SPEED.
param set-default MPC_LAND_SPEED 0.6
param set-default MPC_LAND_ALT1 5
param set-default MPC_LAND_ALT2 2


# Maximum horizontal velocity setpoint for manual controlled mode
param set-default MPC_VEL_MANUAL 3

# Minimum vertical thrust. It's recommended to set it > 0 to avoid free fall with zero thrust. With MC_AIRMODE set to 1, this can safely be set to 0.
param set-default MPC_MANTHR_MIN 0.05

# Maximal tilt angle in manual or altitude mode
# Default
param set-default MPC_MAN_TILT_MAX 35

# Maximum tilt angle in auto modes
param set-default MPC_TILTMAX_AIR 35

# Maximum tilt angle while landing.
# Don't set to a very low value because it won't counter wind while landing.
param set-default MPC_TILTMAX_LND 15

# Max manual yaw rate
param set-default MPC_MAN_Y_MAX 60.0

# This parameter defines how the throttle stick input is mapped to commanded thrust in Manual/Stabilized flight mode.
# In case the default is used ('Rescale to hover thrust'), the stick input is linearly rescaled, such that a centered
# stick corresponds to the hover throttle (see MPC_THR_HOVER). Select 'No Rescale' to directly map the stick 1:1 to the output.
# This can be useful in case the hover thrust is very low and the default would lead to too much distortion
# (e.g. if hover thrust is set to 20%, 80% of the upper thrust range is squeezed into the upper half of the stick range).
# Note: In case MPC_THR_HOVER is set to 50%, the modes 0 and 1 are the same.
# Values:
#     0: Rescale to hover thrust
#     1: No Rescale
param set-default MPC_THR_CURVE 0

# Hover thrust.
# Needs to be calibrated
param set-default MPC_THR_HOVER 0.5

# Max and min thrust in auto
# Min is recommended to set it > 0 to avoid free fall with zero thrust.
param set-default MPC_THR_MAX 1.0
param set-default MPC_THR_MIN 0.1

# Position control smooth takeoff ramp time constant
# Increasing this value will make automatic and manual takeoff slower.
# If it's too slow the drone might scratch the ground and tip over. A time constant of 0 disables the ramp.
# Default
param set-default MPC_TKO_RAMP_T 3

# Takeoff climb rate for auto modes
param set-default MPC_TKO_SPEED 1


# Model specific -> move and add others
# PWM rates. We set 50Hz to AUX as most servos doesn't allow more that that.
param set-default PWM_AUX_RATE 50
param set-default PWM_MAIN_RATE 400

# Other PWM parameters need to be adjusted for each vehicle

#########################
####### RC params #######
#########################

# Arming switch RC mapping
param set-default RC_MAP_ARM_SW 5

# Flight mode RC mapping
param set-default RC_MAP_FLTMODE 6

# Kill Switch RC mapping
param set-default RC_MAP_KILL_SW 9

# Transition switch RC mapping
param set-default RC_MAP_TRANS_SW 7

# Reverse RC 5 (arming switch) as it makes more easy and safe to arm and disarm the vehicle
param set-default RC5_REV 1

# Other RC params must be calibrated for each vehicle


##########################
####### RTL Params #######
##########################

# https://docs.px4.io/v1.12/en/flight_modes/return.html

# Values:
#     0: Return to closest safe point (home or rally point) via direct path.
#     1: Return to closest safe point other than home (mission landing pattern or rally point), via direct path. If no mission landing or rally points are defined return home via direct path.
#     2: Return to a planned mission landing, if available, using the mission path, else return to home via the reverse mission path. Do not consider rally points.
#     3: Return via direct path to closest destination: home, start of mission landing pattern or safe point. If the destination is a mission landing pattern, follow the pattern to land.
param set-default RTL_TYPE 0

# Descend to this altitude (above destination position) after return, and wait for time defined in RTL_LAND_DELAY.
# Land (i.e. slowly descend) from this altitude if autolanding allowed.
# Default
param set-default RTL_DESCEND_ALT 30

# Default minimum altitude above destination (e.g. home, safe point, landing pattern) for return flight.
# Default
param set-default RTL_RETURN_ALT 60


###########################
####### VTOL params #######
###########################

# Airspeed at which we can start blending both fw and mc controls.
# Set to the stall speed
param set-default VT_ARSP_BLEND 15

# Airspeed at which we can switch to fw mode
param set-default VT_ARSP_TRANS 23

# The approximate deceleration during a back transition in m/s/s Used to calculate back transition distance in mission mode.
# A lower value will make the VTOL transition further from the destination waypoint.
# For standard vtol and tiltrotors a controller is used to track this value during the transition.
# Set to default but needs to be tunned.
param set-default VT_B_DEC_MSS 2.0

# Back transition max duration (if vehicle stops before completing the time, it will finish the BT earlier)
# Set to a high value due to slow deceleration. Need to be tunned.
param set-default VT_B_TRANS_DUR 8.0

# This sets the duration during which the MC motors ramp up to the commanded thrust during the back transition stage.
# Set to a low value to fast ramp up
param set-default VT_B_TRANS_RAMP 2.0

# Enable/disable usage of fixed-wing actuators in hover to generate forward force (instead of pitching down)
# Disabled by default. Interesting to test it in the future.
param set-default VT_FWD_THRUST_EN 0

# Minimum altitude for fixed wing flight, when in fixed wing the altitude drops below this altitude the vehicle will transition back to MC mode and enter failsafe RTL
# Virtually disabled now. Test in the future.
param set-default VT_FW_MIN_ALT 0.0

# The channel number of motors that must be turned off in fixed wing mode
param set-default VT_FW_MOT_OFFID 1234

# Throttle during transition.
# Set to 100% but may be lowered if it's excessive
param set-default VT_F_TRANS_THR 0.8

# Defines the time window during which the pusher throttle will be ramped up linearly to VT_F_TRANS_THR during a transition to fixed wing mode.
# Set to low value to fast transitions. May be tunned if the current spike is to high
param set-default VT_PSHER_RMP_DT 2.0

# Idle pwm for MC motors
# Needs to be calibrated on each vehicle.
param set-default VT_IDLE_PWM_MC 1050

# Motors used for MC
param set-default VT_MOT_ID 1234

# Time in seconds after which transition will be cancelled.
# Lower it to 1.5x the consistant time for usual transition.
param set-default VT_TRANS_TIMEOUT 15.0

# Values:
#     0: Tailsitter
#     1: Tiltrotor
#     2: Standard
param set-default VT_TYPE 2



# OTHERS

param set-default IMU_GYRO_RATEMAX 2000
param set-default EKF_IMU_POS_X 0.295
